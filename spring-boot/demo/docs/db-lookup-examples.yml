# ==========================================
# Database Lookup Validation Examples
# ==========================================
# This file demonstrates how to configure database lookup validations
# to verify that cell values exist in database tables before persisting.

# ==========================================
# Example 1: Simple Single-Column Lookup
# ==========================================
# Use Case: Validate that a Department ID exists in the departments table
sheets:
  - name: "Employees"
    columns:
      - name: "Employee ID"
        type: "NUMBER"
        required: true
        rules:
          - NOT_EMPTY
      
      - name: "Name"
        type: "STRING"
        required: true
        rules:
          - NOT_EMPTY
      
      - name: "Department ID"
        type: "NUMBER"
        required: true
        rules:
          - NOT_EMPTY
        # Simple lookup: Check if this department exists
        dbLookup:
          table: "DEPARTMENTS"       # Table to query
          column: "ID"                # Column to check
          errorMessage: "Department with this ID does not exist"
      
      - name: "Manager ID"
        type: "NUMBER"
        required: false
        # Lookup with default error message
        dbLookup:
          table: "EMPLOYEES"
          column: "EMPLOYEE_ID"
          # Default message will be: "Value does not exist in EMPLOYEES.EMPLOYEE_ID"
    
    persistence:
      tableName: "employees"
      upsert: true
      primaryKey: "EMPLOYEE_ID"

# ==========================================
# Example 2: Composite Key Lookup
# ==========================================
# Use Case: Validate combinations like (Country + City) or (Year + Month)
---
sheets:
  - name: "Orders"
    columns:
      - name: "Order ID"
        type: "NUMBER"
        required: true
      
      - name: "Product Code"
        type: "STRING"
        required: true
      
      - name: "Warehouse Country"
        type: "STRING"
        required: true
      
      - name: "Warehouse City"
        type: "STRING"
        required: true
        # Composite lookup: Validate (Country, City) combination
        dbLookup:
          table: "WAREHOUSES"
          columns:                   # Note: 'columns' (plural) for composite keys
            - "COUNTRY"
            - "CITY"
          errorMessage: "No warehouse found for this Country-City combination"
      
      - name: "Quantity"
        type: "NUMBER"
        required: true
    
    persistence:
      tableName: "orders"

# ==========================================
# Example 3: Foreign Key Validation
# ==========================================
# Use Case: Ensure referential integrity before insert
---
sheets:
  - name: "Transactions"
    columns:
      - name: "Transaction ID"
        type: "UUID"
        required: true
        rules:
          - NOT_EMPTY
      
      - name: "Customer ID"
        type: "NUMBER"
        required: true
        rules:
          - NOT_EMPTY
        # Validate customer exists
        dbLookup:
          table: "CUSTOMERS"
          column: "ID"
          errorMessage: "Customer not found. Please create customer first."
      
      - name: "Product SKU"
        type: "STRING"
        required: true
        rules:
          - NOT_EMPTY
        # Validate product exists
        dbLookup:
          table: "PRODUCTS"
          column: "SKU"
          errorMessage: "Product SKU not found in catalog"
      
      - name: "Amount"
        type: "DECIMAL"
        required: true
        rules:
          - NOT_EMPTY
      
      - name: "Currency"
        type: "STRING"
        required: true
        allowedValues: ["USD", "EUR", "GBP"]
        # Validate currency is active in system
        dbLookup:
          table: "CURRENCIES"
          column: "CODE"
          errorMessage: "Currency code not supported"
    
    persistence:
      tableName: "transactions"
      upsert: false

# ==========================================
# Example 4: Email Domain Validation
# ==========================================
# Use Case: Only allow emails from approved domains
---
sheets:
  - name: "User Registration"
    columns:
      - name: "Username"
        type: "STRING"
        required: true
      
      - name: "Email"
        type: "EMAIL"
        required: true
        rules:
          - NOT_EMPTY
          - EMAIL_FORMAT
        transformations:
          - LOWERCASE
          - TRIM
      
      - name: "Email Domain"
        type: "STRING"
        required: true
        # Validate domain is whitelisted
        dbLookup:
          table: "APPROVED_DOMAINS"
          column: "DOMAIN_NAME"
          errorMessage: "Email domain is not approved for registration"
    
    persistence:
      tableName: "users"

# ==========================================
# Example 5: Code/Category Validation
# ==========================================
# Use Case: Validate classification codes, status codes, etc.
---
sheets:
  - name: "Assets"
    columns:
      - name: "Asset ID"
        type: "STRING"
        required: true
      
      - name: "Asset Name"
        type: "STRING"
        required: true
      
      - name: "Category Code"
        type: "STRING"
        required: true
        transformations:
          - UPPERCASE
          - TRIM
        # Validate against master category table
        dbLookup:
          table: "ASSET_CATEGORIES"
          column: "CATEGORY_CODE"
          errorMessage: "Invalid asset category code"
      
      - name: "Status Code"
        type: "STRING"
        required: true
        allowedValues: ["ACTIVE", "INACTIVE", "MAINTENANCE", "RETIRED"]
        # Ensure status exists in workflow table
        dbLookup:
          table: "ASSET_STATUSES"
          column: "STATUS_CODE"
          errorMessage: "Status code not defined in system"
      
      - name: "Location Code"
        type: "STRING"
        required: true
        # Validate location exists
        dbLookup:
          table: "LOCATIONS"
          column: "CODE"
    
    persistence:
      tableName: "assets"
      upsert: true
      primaryKey: "ASSET_ID"

# ==========================================
# Example 6: Hierarchical Data Validation
# ==========================================
# Use Case: Validate parent-child relationships (e.g., State -> Country)
---
sheets:
  - name: "Addresses"
    columns:
      - name: "Address ID"
        type: "NUMBER"
        required: true
      
      - name: "Street"
        type: "STRING"
        required: true
      
      - name: "City"
        type: "STRING"
        required: true
      
      - name: "State Code"
        type: "STRING"
        required: true
        transformations:
          - UPPERCASE
        dbLookup:
          table: "STATES"
          column: "STATE_CODE"
          errorMessage: "Invalid state code"
      
      - name: "Country Code"
        type: "STRING"
        required: true
        transformations:
          - UPPERCASE
        dbLookup:
          table: "COUNTRIES"
          column: "ISO_CODE"
          errorMessage: "Invalid ISO country code"
      
      - name: "Postal Code"
        type: "STRING"
        required: true
    
    persistence:
      tableName: "addresses"

# ==========================================
# Example 7: Multi-Tenant Validation
# ==========================================
# Use Case: Ensure entity belongs to correct tenant/organization
---
sheets:
  - name: "Project Tasks"
    columns:
      - name: "Task ID"
        type: "NUMBER"
        required: true
      
      - name: "Project ID"
        type: "NUMBER"
        required: true
        dbLookup:
          table: "PROJECTS"
          column: "ID"
          errorMessage: "Project does not exist"
      
      - name: "Organization ID"
        type: "NUMBER"
        required: true
      
      - name: "Assigned User Email"
        type: "EMAIL"
        required: true
        rules:
          - EMAIL_FORMAT
        # Validate user exists and belongs to org (composite check)
        dbLookup:
          table: "USERS"
          columns:
            - "EMAIL"
            - "ORGANIZATION_ID"
          errorMessage: "User not found in this organization"
      
      - name: "Task Name"
        type: "STRING"
        required: true
    
    persistence:
      tableName: "tasks"

# ==========================================
# IMPORTANT NOTES
# ==========================================
# 
# 1. Single Column vs Composite Lookups:
#    - Use 'column' (singular) for single-column lookups
#    - Use 'columns' (plural array) for multi-column lookups
#    - Cannot specify both 'column' and 'columns'
#
# 2. Performance Considerations:
#    - Database lookups add query overhead
#    - Consider adding database indexes on lookup columns
#    - Use batch validation where possible
#
# 3. Error Messages:
#    - Custom messages via 'errorMessage' field
#    - If omitted, default message includes table.column info
#
# 4. Validation Order:
#    - Transformations run first (TRIM, UPPERCASE, etc.)
#    - Then type validation
#    - Then rules (NOT_EMPTY, EMAIL_FORMAT, etc.)
#    - Then allowedValues check
#    - Finally dbLookup validation (before persistence)
#
# 5. Composite Key Matching:
#    - Order of columns in 'columns' array must match
#      the order of Excel columns being validated
#    - All columns must match for validation to pass
